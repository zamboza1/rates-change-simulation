<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US Treasury Rates Change Simulator</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for High Performance Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #F8FAFC;
        }

        /* Glassmorphism utils */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Slider styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #38BDF8;
            margin-top: -6px;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex">
    <div id="root" class="w-full h-full flex"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- COMPONENTS ---

        function MetricCard({ label, value, delta, subtext }) {
            const isPos = delta > 0;
            const color = isPos ? 'text-emerald-400' : (delta < 0 ? 'text-rose-400' : 'text-slate-400');
            const sign = isPos ? '+' : '';

            return (
                <div className="glass p-5 rounded-xl flex flex-col justify-between hover:border-slate-500 transition-colors duration-300">
                    <div className="text-slate-400 text-sm font-medium tracking-wide uppercase">{label}</div>
                    <div className="text-3xl font-bold text-white mt-1">{value}</div>
                    <div className={`text-sm mt-3 font-mono flex items-center ${color}`}>
                        {delta !== null && <span className="mr-1">{sign}{delta} bps</span>}
                        {subtext && <span className="text-slate-500 ml-2 text-xs">{subtext}</span>}
                    </div>
                </div>
            );
        }

        function SliderControl({ label, value, min, max, onChange, help }) {
            return (
                <div className="mb-6">
                    <div className="flex justify-between items-end mb-2">
                        <label className="text-slate-300 text-sm font-medium">{label}</label>
                        <span className="text-sky-400 font-mono text-sm">{value > 0 ? '+' : ''}{value} bps</span>
                    </div>
                    <input
                        type="range"
                        min={min} max={max} value={value}
                        onChange={(e) => onChange(parseFloat(e.target.value))}
                        className="w-full"
                    />
                    {help && <div className="text-slate-500 text-xs mt-1">{help}</div>}
                </div>
            );
        }

        // --- MAIN APP ---

        function App() {
            const [data, setData] = useState({ original: {}, shocked: {}, metrics: {} });
            const [date, setDate] = useState("Loading...");
            const [error, setError] = useState(null);
            const [shockType, setShockType] = useState("parallel");
            const [magnitude, setMagnitude] = useState(0);
            const [customShocks, setCustomShocks] = useState({ 2: 0, 5: 0, 10: 0, 30: 0 });
            const [chartInstance, setChartInstance] = useState(null);
            const chartRef = useRef(null);

            // API: Fetch base data once
            useEffect(() => {
                fetch("http://127.0.0.1:8081/api/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ type: "parallel", magnitude: 0 })
                })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(err => Promise.reject(err));
                        }
                        return res.json();
                    })
                    .then(json => {
                        setError(null);
                        setDate(json.date);
                        setData({
                            original: json.original_curve,
                            shocked: json.shocked_curve,
                            metrics: json.metrics
                        });
                    })
                    .catch(err => {
                        console.error("API Error:", err);
                        const errorMsg = err.detail || err.message || "Unable to fetch Treasury data. The backend service may be unavailable.";
                        setError(errorMsg);
                        setDate("Data Unavailable");
                    });
            }, []);

            // API: Update on Scenario Change
            useEffect(() => {
                // Don't fetch if there's already an error
                if (error) return;

                const timer = setTimeout(() => {
                    fetch("http://127.0.0.1:8081/api/analyze", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            type: shockType,
                            magnitude: magnitude,
                            pivot: 2.0, // hardcoded for steepener gui
                            custom_shocks: customShocks
                        })
                    })
                        .then(res => {
                            if (!res.ok) {
                                return res.json().then(err => Promise.reject(err));
                            }
                            return res.json();
                        })
                        .then(json => {
                            setError(null);
                            setData({
                                original: json.original_curve,
                                shocked: json.shocked_curve,
                                metrics: json.metrics
                            });
                        })
                        .catch(err => {
                            console.error("Scenario update error:", err);
                        });
                }, 50); // Debounce slightly
                return () => clearTimeout(timer);
            }, [shockType, magnitude, customShocks, error]);

            // Helper: Format Tenor (0.083 -> 1M, 30 -> 30Y)
            const formatTenor = (t) => {
                const val = parseFloat(t);
                if (val < 1) return Math.round(val * 12) + "M";
                return val + "Y";
            };

            // Chart Rendering logic using Chart.js
            useEffect(() => {
                if (!chartRef.current || Object.keys(data.original).length === 0) return;

                const tenors = Object.keys(data.original).sort((a, b) => parseFloat(a) - parseFloat(b));
                const labels = tenors.map(formatTenor); // Use pretty labels
                const origVals = tenors.map(t => data.original[t]);
                const shockVals = tenors.map(t => data.shocked[t]);

                if (chartInstance) {
                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets[0].data = origVals;
                    chartInstance.data.datasets[1].data = shockVals;
                    chartInstance.update('none');
                } else {
                    const ctx = chartRef.current.getContext('2d');
                    const newChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Baseline',
                                    data: origVals,
                                    borderColor: '#64748B',
                                    borderDash: [5, 5],
                                    borderWidth: 2,
                                    pointRadius: 0,
                                    tension: 0.4
                                },
                                {
                                    label: 'Scenario',
                                    data: shockVals,
                                    borderColor: '#38BDF8',
                                    backgroundColor: 'rgba(56, 189, 248, 0.1)',
                                    fill: true,
                                    borderWidth: 3,
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { labels: { color: '#94A3B8' } },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleColor: '#F8FAFC',
                                    bodyColor: '#E2E8F0',
                                    borderColor: '#334155',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: { grid: { color: '#1E293B' }, ticks: { color: '#64748B' } },
                                y: { grid: { color: '#1E293B' }, ticks: { color: '#64748B' } }
                            },
                            animation: { duration: 0 }
                        }
                    });
                    setChartInstance(newChart);
                }
            }, [data, chartRef]);

            // Metric Helpers
            const getM = (tenor) => {
                if (!data.metrics) return { yield: 0, delta: 0 };
                const m = data.metrics[tenor + ".0"];
                return m ? { yield: m.yield.toFixed(2) + "%", delta: (m.delta_bps).toFixed(1) } : { yield: "-", delta: "-" };
            };

            const m2 = getM(2);
            const m10 = getM(10);
            const m30 = getM(30);

            return (
                <div className="flex w-full h-full bg-[#0F172A]">
                    {/* Error Banner */}
                    {error && (
                        <div className="fixed top-0 left-0 right-0 z-50 bg-rose-900 border-b border-rose-700 p-4">
                            <div className="max-w-7xl mx-auto flex items-start">
                                <div className="flex-shrink-0">
                                    <svg className="h-5 w-5 text-rose-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                    </svg>
                                </div>
                                <div className="ml-3">
                                    <h3 className="text-sm font-medium text-rose-200">Treasury Data Unavailable</h3>
                                    <div className="mt-1 text-sm text-rose-300">{error}</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SIDEBAR */}
                    <div className="w-80 glass-panel p-6 flex flex-col shrink-0 overflow-y-auto">
                        <div className="flex items-center space-x-2 mb-8">
                            <div className="w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
                            <h1 className="text-xl font-bold tracking-tight text-white">US Treasury Rates Change Simulator</h1>
                        </div>

                        <div className="mb-8">
                            <div className="text-slate-500 text-xs font-semibold uppercase mb-4 tracking-wider">Scenarios</div>

                            <div className="flex bg-slate-800 p-1 rounded-lg mb-6">
                                {['parallel', 'steepener', 'custom'].map(mode => (
                                    <button
                                        key={mode}
                                        onClick={() => { setShockType(mode); setMagnitude(0); }}
                                        className={`flex-1 py-1.5 text-xs font-medium rounded-md transition-all ${shockType === mode ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-slate-300'
                                            }`}
                                    >
                                        {mode.charAt(0).toUpperCase() + mode.slice(1)}
                                    </button>
                                ))}
                            </div>

                            {shockType !== 'custom' ? (
                                <SliderControl
                                    label={shockType === 'parallel' ? 'Shift Magnitude' : 'Twist Severity'}
                                    value={magnitude} min={-200} max={200}
                                    onChange={setMagnitude}
                                    help={
                                        shockType === 'parallel'
                                            ? "Moves the whole curve up or down. For instance, aggressive Fed hikes or total market repricing."
                                            : "Twists the curve around the 2Y. This can simulate inflation scares (long end up) or recession signals (inversion)."
                                    }
                                />
                            ) : (
                                <div className="space-y-4 animate-in fade-in duration-500">
                                    <div className="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-2">Manual Shocks (bps)</div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {[2, 5, 10, 30].map(t => (
                                            <div key={t} className="flex flex-col">
                                                <label className="text-slate-400 text-[10px] mb-1 font-mono">{t}Y</label>
                                                <input
                                                    type="number"
                                                    placeholder="0"
                                                    className="bg-slate-900 border border-slate-700 rounded p-2 text-sm text-sky-400 focus:outline-none focus:border-sky-500"
                                                    onChange={(e) => {
                                                        const val = parseFloat(e.target.value) || 0;
                                                        setCustomShocks(prev => ({ ...prev, [t]: val }));
                                                    }}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                    <div className="text-slate-500 text-xs mt-4">
                                        Manually adjust specific points on the curve.
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="mt-auto">
                            <div className="p-4 rounded-lg bg-slate-900 border border-slate-800 text-xs text-slate-400">
                                <span className="block mb-2 font-mono text-emerald-400">‚óè LIVE FEED</span>
                                Data loaded: {date}<br />
                                Source: US Treasury
                            </div>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col p-8 overflow-hidden relative">
                        {/* HEADER METRICS */}
                        <div className="grid grid-cols-3 gap-6 mb-8 shrink-0">
                            <MetricCard label="2Y Yield" value={m2.yield} delta={m2.delta} />
                            <MetricCard label="10Y Yield" value={m10.yield} delta={m10.delta} />
                            <MetricCard label="30Y Yield" value={m30.yield} delta={m30.delta} />
                        </div>

                        {/* CHART AREA */}
                        <div className="flex-1 glass rounded-2xl p-6 relative flex flex-col min-h-0">
                            <div className="absolute top-6 left-6 z-10">
                                <h2 className="text-lg font-semibold text-white">Yield Curve Structure</h2>
                                <p className="text-slate-400 text-sm">Visualizing term structure dynamics</p>
                            </div>
                            <div className="flex-1 mt-8 relative w-full h-full">
                                <canvas ref={chartRef}></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>